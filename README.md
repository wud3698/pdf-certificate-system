。

# PDF证件管理系统

一个基于Flask的PDF证件管理系统，支持Excel数据导入、图片处理、证件生成和管理等功能。

## 🎯 主要功能

### 核心功能
- **Excel数据导入**：支持15字段结构的Excel文件导入
- **图片处理**：自动从Excel提取参赛者照片并处理
- **证件生成**：基于Word模板生成PDF证件
- **证件管理**：完整的CRUD操作和搜索功能
- **活动管理**：多活动支持，独立管理
- **用户认证**：管理员登录和权限控制

### 特色功能
- **智能图片提取**：从Excel单元格直接提取插入的图片
- **图片尺寸选择**：支持一寸照、二寸照、小二寸等多种预设尺寸，以及智能尺寸计算
- **响应式界面**：支持各种设备的现代化Web界面
- **批量操作**：支持批量生成、下载、删除证件
- **灵活字段映射**：用户可自定义Excel列与系统字段的对应关系
- **图片预览**：在管理界面直接查看参赛者照片

## 📋 字段结构

系统支持以下15个字段：

| 字段名 | 中文名称 | 类型 | 必填 | 说明 |
|--------|----------|------|------|------|
| cert_number | 证件编号 | 文本 | ✅ | 唯一标识符 |
| unit_name | 单位名称 | 文本 | ✅ | 参赛单位 |
| area | 所属区域 | 文本 | ❌ | 地理区域 |
| name | 姓名 | 文本 | ✅ | 参赛者姓名 |
| id_type | 证件类型 | 文本 | ❌ | 身份证、护照等 |
| id_number | 证件号 | 文本 | ❌ | 证件号码 |
| gender | 性别 | 文本 | ❌ | 男/女 |
| age | 年龄 | 数字 | ❌ | 参赛者年龄 |
| birth_date | 出生日期 | 日期 | ❌ | YYYY-MM-DD格式 |
| phone | 手机号 | 文本 | ❌ | 联系电话 |
| identity | 身份 | 文本 | ❌ | 学生、教师等 |
| grade_major | 年级专业 | 文本 | ❌ | 年级或专业信息 |
| image_path | 图片 | 文件 | ❌ | 参赛者照片 |
| image_path_backup | 备用图片 | 文件 | ❌ | 备用参赛者照片 |
| project | 参赛项目 | 文本 | ❌ | 具体参赛项目 |
| param_group | 参数组别 | 文本 | ❌ | 分组信息 |

## 🚀 快速开始

### 环境要求
- Python 3.8+
- MySQL 5.7+
- LibreOffice（用于PDF转换）

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd pdf
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **配置数据库**
```bash
# 创建MySQL数据库
mysql -u root -p
CREATE DATABASE pdf_certificates CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

4. **环境配置**
```bash
# 复制配置文件并修改数据库连接信息
cp config.py.example config.py
# 编辑config.py，设置数据库连接信息
```

5. **初始化数据库**
```bash
python update_database.py
```

6. **启动应用**
```bash
python run.py
```

**重要提示：** 首次启动时，如果admin表为空，系统会自动创建默认管理员账号：
- **用户名**: `admin`
- **密码**: `admin123`
- **创建条件**: 仅当admin表中没有任何管理员账号时才创建
- **安全建议**: 登录后请立即修改密码以确保安全！

7. **访问系统**
- 前台：http://localhost:5000
- 后台：http://localhost:5000/admin
- 管理员登录：用户名 `admin`，密码 `admin123`（如果是自动创建的账号）

## 📁 项目结构

```
pdf/
├── app/                          # 应用主包
│   ├── models/                   # 数据模型
│   │   ├── __init__.py          # 模型初始化
│   │   ├── certificate.py      # 证书模型（15字段）
│   │   ├── activity.py         # 活动模型
│   │   ├── admin.py            # 管理员模型
│   │   └── carousel_image.py   # 轮播图模型
│   ├── routes/                  # 路由控制器
│   │   ├── __init__.py         # 路由初始化
│   │   ├── main.py             # 前台路由
│   │   ├── admin_backup.py     # 原admin路由备份文件
│   │   └── admin/              # 后台路由模块
│   │       ├── __init__.py     # admin模块初始化
│   │       ├── auth.py         # 管理员认证路由
│   │       ├── activities.py   # 活动管理路由
│   │       ├── certificates.py # 证书管理路由
│   │       ├── generate.py     # 证书生成路由
│   │       ├── users.py        # 用户管理路由
│   │       ├── site.py         # 站点设置路由
│   │       └── downloads.py    # 下载功能路由
│   ├── services/               # 业务服务层
│   │   ├── __init__.py         # 服务初始化
│   │   ├── certificate_generator.py  # 证书生成服务
│   │   ├── certificate_service.py    # 证书管理服务
│   │   └── image_service.py    # 图片处理服务
│   ├── __init__.py             # 应用工厂函数
│   ├── config.py               # 配置文件
│   └── auth.py                 # 认证模块
├── templates/                   # 模板文件
│   ├── base.html               # 基础模板
│   ├── index.html              # 首页模板
│   ├── activity_detail.html    # 活动详情模板
│   ├── unit_certificates.html  # 单位证书模板
│   ├── help.html               # 帮助页面模板
│   ├── search_results.html     # 搜索结果模板
│   └── admin/                  # 管理后台模板
│       ├── base.html           # 后台基础模板
│       ├── login.html          # 登录页面
│       ├── activities.html     # 活动管理页面
│       ├── certificates.html   # 证书管理页面（已优化）
│       ├── upload.html         # 数据上传页面（已优化）
│       ├── generate.html       # 证书生成页面
│       ├── admins.html         # 管理员管理页面
│       └── site.html           # 站点设置页面
├── static/                     # 静态文件
│   ├── css/                    # 样式文件
│   │   ├── admin/              # 后台页面样式
│   │   │   └── generate.css    # 证书生成页面样式 (9.3KB)
│   │   ├── admin-certificates.css  # 证书管理页面样式 (7.5KB)
│   │   └── upload.css          # 数据上传页面样式 (11KB)
│   ├── js/                     # JavaScript文件
│   │   ├── admin/              # 后台页面脚本
│   │   │   └── generate.js     # 证书生成页面脚本 (11KB)
│   │   ├── admin-certificates.js   # 证书管理页面脚本 (12KB)
│   │   └── upload.js           # 数据上传页面脚本 (8KB)
│   ├── fonts/                  # 字体文件
│   └── uploads/                # 历史上传文件
├── uploads/                    # 上传文件目录
│   ├── templates/              # 证书模板
│   ├── certificates/           # 生成的证书
│   ├── images/                 # 活动图片
│   ├── carousel/               # 轮播图
│   ├── participant_images/     # 参赛者照片
│   └── temp/                   # 临时文件
├── migrations/                 # 数据库迁移文件
├── docs/                       # 文档目录
├── tools/                      # 工具脚本
├── run.py                      # 应用入口文件
├── requirements.txt            # 依赖包列表
├── update_database.py          # 数据库更新脚本
├── 示例Excel模板.md           # Excel模板说明
├── FIELD_UPDATE_SUMMARY.md    # 字段更新总结
├── STRUCTURE.md               # 项目结构说明
├── REFACTOR_SUMMARY.md        # 重构总结文档
├── README.md                  # 项目说明（本文件）
├── .gitignore                 # Git忽略文件
└── .htaccess                  # Apache配置文件
```

## 🖼️ 图片处理功能

### 支持的图片格式
- PNG、JPG、JPEG、GIF、BMP

### 图片处理特性
- **自动提取**：从Excel文件中提取插入的图片
- **格式转换**：自动转换为PNG格式
- **尺寸调整**：自动调整为300x400像素
- **压缩优化**：减少文件大小
- **预览功能**：在管理界面显示缩略图
- **智能尺寸**：自动分析图片比例，计算最适合的显示尺寸（NEW v2.1）

### 智能尺寸计算功能 🧠
系统会自动分析每张图片的原始尺寸和宽高比，然后：
- 计算出最适合的显示尺寸（默认目标宽度3.5cm）
- 根据图片比例自动调整高度
- 设置最大/最小尺寸限制（2-6cm范围内）
- 确保图片完整显示，不会被裁切
- 保持图片原始比例，不会变形

**示例：**
- 原图326x490像素（宽高比0.67）→ 显示为3.5cm x 5.3cm
- 原图400x300像素（宽高比1.33）→ 显示为3.5cm x 2.6cm

### 使用方法
1. 在Excel中选择图片列的单元格
2. 插入 → 图片 → 来自此设备
3. 选择参赛者照片并插入
4. 上传Excel文件时系统自动提取图片
5. 生成证书时智能计算最佳显示尺寸

## 📊 数据导入流程

1. **准备Excel文件**
   - 第一行为标题行
   - 按照15字段结构填写数据
   - 可直接在Excel中插入参赛者照片

2. **上传和映射**
   - 选择活动
   - 上传Excel文件
   - 进行字段映射（将Excel列对应到系统字段）

3. **数据处理**
   - 系统自动验证数据
   - 提取和处理图片
   - 保存到数据库

4. **证书管理**
   - 查看、编辑、搜索证书信息
   - 生成PDF证书
   - 批量下载

## 🎨 界面特性

### 管理后台
- **现代化设计**：Bootstrap 5响应式界面
- **图片预览**：直接在列表中查看参赛者照片
- **高级搜索**：支持多字段组合搜索
- **批量操作**：选中多个记录进行批量操作
- **分页显示**：支持大数据量的分页浏览

### 编辑界面
- **大型模态框**：容纳更多字段
- **智能表单**：必填项标记、下拉选择、日期选择
- **实时验证**：表单数据实时验证
- **响应式布局**：适配各种屏幕尺寸

## 🏗️ 代码结构优化

### 前端资源分离
为了提高代码的可维护性和性能，系统已经进行了前端代码结构优化：

#### CSS 样式分离
- **独立样式文件**：每个页面都有独立的CSS文件
- **模块化设计**：`admin-certificates.css`、`upload.css` 等页面专用样式
- **CSS 变量**：使用 CSS 自定义属性统一管理颜色和尺寸
- **响应式设计**：包含完整的移动端适配样式

#### JavaScript 脚本分离
- **独立脚本文件**：每个页面都有独立的JS文件
- **功能模块化**：按功能划分不同的函数
- **异步处理**：使用现代 async/await 语法
- **错误处理**：完善的错误捕获和用户提示

#### 优化效果
- **✅ 提高可维护性**：代码结构清晰，便于修改和扩展
- **✅ 改善性能**：外部文件可被浏览器缓存，减少重复加载
- **✅ 增强可读性**：HTML、CSS、JS 职责分离，代码更清晰
- **✅ 便于调试**：独立文件便于开发者工具调试和错误定位
- **✅ 支持压缩**：生产环境可以对静态文件进行压缩优化

#### 文件组织结构
```
static/
├── css/
│   ├── admin/
│   │   └── generate.css         # 证书生成页面样式 (9.3KB)
│   ├── admin-certificates.css    # 证书管理页面样式 (7.5KB)
│   └── upload.css               # 数据上传页面样式 (11KB)
└── js/
    ├── admin/
    │   └── generate.js          # 证书生成页面脚本 (11KB)
    ├── admin-certificates.js     # 证书管理页面脚本 (12KB)
    └── upload.js                # 数据上传页面脚本 (8KB)
```

#### 技术特性
- **现代化语法**：使用ES6+语法特性
- **事件委托**：优化事件处理性能
- **数据绑定**：使用data属性传递参数，避免模板语法冲突
- **加载状态管理**：统一的loading状态控制
- **通知系统**：用户友好的操作反馈

#### 分离完成的页面
1. **证书管理页面** (`admin/certificates.html`)
   - 分离出 `admin-certificates.css` (7.5KB)
   - 分离出 `admin-certificates.js` (12KB)
   - 功能：数据表格、搜索、编辑、批量操作等

2. **数据上传页面** (`admin/upload.html`)
   - 分离出 `upload.css` (11KB)
   - 分离出 `upload.js` (8KB)
   - 功能：文件上传、字段映射、步骤指示器、拖拽上传等

3. **证书生成页面** (`admin/generate.html`)
   - 分离出 `admin/generate.css` (9.3KB)
   - 分离出 `admin/generate.js` (11KB)
   - 功能：活动选择、模板管理、证书生成、文件拖拽上传等

## ⚙️ 配置说明

### 数据库配置
```python
# config.py
SQLALCHEMY_DATABASE_URI = 'mysql://username:password@localhost/database_name'
```

### 文件路径配置
```python
UPLOAD_FOLDER = 'uploads'
CERTIFICATE_TEMPLATE_FOLDER = 'uploads/templates'
GENERATED_CERTIFICATES_FOLDER = 'uploads/certificates'
```

### 图片处理配置
```python
MAX_IMAGE_SIZE = (300, 400)  # 最大图片尺寸
ALLOWED_IMAGE_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'bmp'}
```

## 📝 证书模板

### Word模板字段
在Word模板中可以使用以下合并字段：
```
{{ cert_number }}     # 证书编号
{{ unit_name }}       # 单位名称
{{ area }}           # 所属区域
{{ name }}           # 姓名
{{ project }}        # 参赛项目
{{ param_group }}    # 参数组别
... 其他字段
```

### 图片字段
```
{{ image_path }}        # 主要参赛者照片（支持多种尺寸）
{{ image_path_backup }} # 备用参赛者照片（支持独立尺寸设置）
```

**重要说明：**
- 在Word模板中使用 `{{ image_path }}` 或 `{{ image_path_backup }}` 时，系统会自动插入参赛者照片
- **独立尺寸控制**：两个图片字段可以设置不同的显示尺寸
- **主图片字段** (`{{ image_path }}`): 默认一寸照尺寸 (2.5cm x 3.5cm)
- **备用图片字段** (`{{ image_path_backup }}`): 默认正方形小尺寸 (2.5cm x 2.5cm)
- **多种预设尺寸**：支持一寸照、二寸照、小二寸、正方形（小中大）、自定义尺寸等
- **智能尺寸计算**：选择"智能尺寸"时会自动分析图片比例，计算最适合的显示尺寸
- **完整显示**：确保图片不会被裁切，保持原始比例
- **灵活应用**：主图片适合证件照，备用图片适合签名、印章等正方形元素
- 如果图片文件不存在，该字段会被跳过

**预设尺寸选项：**
- **一寸照**：2.5cm x 3.5cm（标准证件照）
- **二寸照**：3.5cm x 5.3cm（大证件照）
- **小二寸**：3.3cm x 4.8cm（中等证件照）
- **正方形小**：2.5cm x 2.5cm（适合签名、印章）
- **正方形中**：3.0cm x 3.0cm（中等正方形）
- **正方形大**：4.0cm x 4.0cm（大正方形）
- **自定义尺寸**：小(2.0x2.8)、中(4.0x5.5)、大(5.0x7.0)

**智能尺寸规则：**
- 默认目标宽度：3.5cm（接近标准二寸照片宽度）
- 高度根据图片比例自动计算
- 最大尺寸限制：5.0cm x 6.0cm
- 最小尺寸限制：2.0cm x 2.0cm
- 适用于各种图片比例，从证件照到风景照

**模板设计建议：**
- 在Word模板中直接使用 `{{ image_path }}` 即可
- 系统会自动处理图片尺寸，无需手动设置
- 如果需要特定位置，可以在图片字段前后添加适当的文字或空格
- 支持Word中的段落对齐（居左、居中、居右）

**详细设置方法请参考：** [Word模板图片设置说明.md](Word模板图片设置说明.md)

## 🔧 开发指南

### 添加新字段
1. 更新`app/models/certificate.py`模型
2. 创建数据库迁移脚本
3. 更新相关模板和表单
4. 更新字段映射逻辑

### 自定义图片处理
在`app/services/image_service.py`中修改图片处理逻辑：
```python
def resize_image(self, image_path, max_width=300, max_height=400):
    # 自定义图片处理逻辑
```

## 🐛 故障排除

### 常见问题

1. **图片无法显示**
   - 检查`uploads/participant_images/`目录权限
   - 确认图片文件存在
   - 检查图片格式是否支持

2. **Excel导入失败**
   - 确认Excel文件格式为.xlsx
   - 检查必填字段是否完整
   - 验证字段映射是否正确

3. **PDF生成失败**
   - 确认LibreOffice已安装
   - 检查模板文件是否存在
   - 验证字体支持

4. **数据库连接失败**
   - 检查数据库服务是否启动
   - 验证连接字符串配置
   - 确认数据库权限

## 📜 更新历史

### v2.8 (当前版本)
- ✅ **备用图片独立尺寸控制**：`image_path_backup` 字段支持独立的尺寸设置
- ✅ **新增正方形尺寸预设**：添加2.5cm×2.5cm、3.0cm×3.0cm、4.0cm×4.0cm正方形尺寸选项
- ✅ **双图片尺寸选择界面**：证书生成页面支持分别为主图片和备用图片选择不同尺寸
- ✅ **默认尺寸优化**：备用图片默认使用2.5cm×2.5cm正方形，适合签名、印章等元素
- ✅ **完整参数传递**：前后端完整支持两个图片字段的独立尺寸参数传递
- ✅ **文档完善**：更新说明文档，详细描述双图片字段的独立尺寸控制功能

### v2.7
- ✅ **新增备用图片字段**：在数据模型中添加 `image_path_backup` 字段
- ✅ **字段映射增强**：Excel数据导入支持备用图片字段映射
- ✅ **证件生成扩展**：证件生成器支持处理备用图片字段
- ✅ **模板支持**：Word模板中可使用 `{{ image_path_backup }}` 插入备用图片
- ✅ **管理界面更新**：后台管理界面支持查看和管理备用图片字段
- ✅ **Excel导入修复**：修复备用图片字段与主图片字段使用相同图片的问题

### v2.6
- ✅ **界面文案统一**：将系统所有界面中的"证书"统一修改为"证件"
- ✅ **模板文件更新**：更新所有HTML模板文件，包括 `index.html`、`base.html`、`generate.html`、`activity_detail.html`、`certificates.html`
- ✅ **用户体验一致性**：确保前台和后台界面术语统一，提升专业性
- ✅ **文档同步更新**：README.md 文档同步更新相关描述
- ✅ **向下兼容**：仅修改界面显示文案，不影响数据结构和功能

### v2.5
- ✅ **图片尺寸选择功能**：新增图片尺寸选择功能，支持一寸照、二寸照、小二寸、自定义尺寸等多种选项
- ✅ **证件生成增强**：在证件生成页面和证件管理页面均可选择图片显示尺寸
- ✅ **智能尺寸计算**：保留原有的智能尺寸计算功能，新增预设尺寸选项
- ✅ **用户体验优化**：提供直观的尺寸选择界面，默认为一寸照片尺寸
- ✅ **向下兼容**：新功能完全向下兼容，不影响现有证件生成功能

### v2.4
- ✅ **证书生成页面代码分离**：完成 `admin/generate.html` 页面的 CSS 和 JavaScript 分离
- ✅ **标准化目录结构**：建立 `static/css/admin/` 和 `static/js/admin/` 子目录
- ✅ **三大核心页面优化完成**：证书管理、数据上传、证书生成页面全部完成代码分离
- ✅ **开发体验进一步提升**：统一的代码组织方式，便于维护和扩展
- ✅ **性能优化全面覆盖**：所有主要功能页面均支持静态资源缓存

### v2.3
- ✅ **完成全面代码分离**：数据上传页面 CSS 和 JavaScript 分离
- ✅ **统一前端架构**：所有主要页面均完成代码分离优化
- ✅ **文件组织优化**：建立完整的 `static/css/` 和 `static/js/` 目录结构
- ✅ **开发效率提升**：模块化开发，便于团队协作和维护
- ✅ **性能优化增强**：所有外部资源文件支持浏览器缓存

### v2.2
- ✅ **代码结构优化**：证书管理页面 CSS 和 JavaScript 文件分离
- ✅ **前端性能提升**：外部文件缓存，减少重复加载
- ✅ **可维护性增强**：模块化代码结构，便于开发和调试
- ✅ **现代化语法**：使用 ES6+ 和现代前端开发模式
- ✅ **响应式优化**：完善的移动端适配和用户体验

### v2.1
- ✅ 新增智能图片尺寸计算功能
- ✅ 自动分析图片比例和尺寸
- ✅ 确保图片完整显示，不被裁切
- ✅ 支持各种图片比例的自动适配
- ✅ 优化图片显示效果

### v2.0
- ✅ 支持15字段结构
- ✅ 新增图片处理功能
- ✅ 更新所有页面界面
- ✅ 优化用户体验
- ✅ 完善文档

### v1.0
- 基础证书管理功能
- Excel数据导入
- PDF证书生成
- 管理后台

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📞 支持

如有问题，请查看文档或提交Issue。 
